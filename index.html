<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Exploration Map – Date Slider</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body {
      margin: 0;
      height: 100%;
      background: #111;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }
    #map { height: 85%; }

    #ui {
      height: 15%;
      padding: 10px 14px;
      background: #1a1a1a;
      color: #ddd;
      box-sizing: border-box;
    }

    .row {
      margin-bottom: 8px;
    }

    input[type="file"], input[type="range"], button {
      width: 100%;
      font-size: 12px;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #333;
      background: #111;
      color: #ddd;
    }

    button { cursor: pointer; }

    #dateLabel {
      font-size: 13px;
      color: #ccc;
    }

    #status {
      font-size: 11px;
      color: #888;
    }
  </style>
</head>
<body>

<div id="map"></div>

<div id="ui">
  <div class="row">
    <input type="file" id="logInput" multiple />
  </div>

  <div class="row">
    <input type="range" id="dateSlider" min="0" max="0" value="0" disabled />
    <div id="dateLabel">ログ未読込</div>
  </div>

  <div class="row">
    <button id="clearBtn">クリア</button>
  </div>

  <div class="row" id="status">ログを選択してください</div>
</div>

<script>
  // ===== 地図
  const map = L.map('map').setView([35.721625, 140.155500], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  // ===== グリッド
  const GRID_LAT = 0.00012;
  const GRID_LNG = 0.00035;

  function gridKey(lat, lng) {
    return `${Math.floor(lat / GRID_LAT)}_${Math.floor(lng / GRID_LNG)}`;
  }
  function gridBounds(key) {
    const [x, y] = key.split('_').map(Number);
    return [[x*GRID_LAT, y*GRID_LNG], [(x+1)*GRID_LAT, (y+1)*GRID_LNG]];
  }

  let allPoints = [];
  let dates = [];
  let fogRects = [];
  let clearRects = [];

  const logInput = document.getElementById('logInput');
  const slider = document.getElementById('dateSlider');
  const label = document.getElementById('dateLabel');
  const status = document.getElementById('status');

  function clearLayers(arr) {
    arr.forEach(r => map.removeLayer(r));
    arr.length = 0;
  }

  function drawFog() {
    const b = map.getBounds();
    for (let x = Math.floor(b.getSouth()/GRID_LAT); x <= Math.floor(b.getNorth()/GRID_LAT); x++) {
      for (let y = Math.floor(b.getWest()/GRID_LNG); y <= Math.floor(b.getEast()/GRID_LNG); y++) {
        fogRects.push(
          L.rectangle(gridBounds(`${x}_${y}`), {
            color: null, fillColor: '#0e0e11', fillOpacity: 0.45, weight: 0
          }).addTo(map)
        );
      }
    }
  }

  function drawClear(date) {
    const pts = allPoints.filter(p => p.date === date);
    const countMap = new Map();

    pts.forEach(p => {
      const k = gridKey(p.lat, p.lng);
      countMap.set(k, (countMap.get(k) || 0) + 1);
    });

    countMap.forEach((count, k) => {
      clearRects.push(
        L.rectangle(gridBounds(k), {
          color: null,
          fillColor: '#fff',
          fillOpacity: Math.min(0.55, 0.3 + count*0.1),
          weight: 0
        }).addTo(map)
      );
    });
  }

  function render(index) {
    clearLayers(fogRects);
    clearLayers(clearRects);
    drawFog();

    const date = dates[index];
    if (!date) return;

    drawClear(date);
    label.textContent = `${date}（${index+1} / ${dates.length}）`;
  }

  function parseLog(text) {
    const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
    const pts = [];
    let lat=null,lng=null,time=null;

    lines.forEach(l => {
      if (l.startsWith('緯度:')) lat = parseFloat(l.replace('緯度:',''));
      if (l.startsWith('経度:')) lng = parseFloat(l.replace('経度:',''));
      if (l.startsWith('時刻:')) time = l.replace('時刻:','').trim();

      if (lat && lng && time) {
        pts.push({
          lat, lng,
          date: time.slice(0,10).replace(/\//g,'-')
        });
        lat=lng=time=null;
      }
    });
    return pts;
  }

  logInput.addEventListener('change', e => {
    const files = e.target.files;
    allPoints = [];
    let done = 0;

    Array.from(files).forEach(f => {
      const r = new FileReader();
      r.onload = () => {
        allPoints.push(...parseLog(r.result));
        done++;
        if (done === files.length) {
          dates = Array.from(new Set(allPoints.map(p=>p.date))).sort();
          slider.max = dates.length - 1;
          slider.value = slider.max;
          slider.disabled = false;
          status.textContent = `${files.length}ファイル / ${dates.length}日分`;
          render(slider.value);
        }
      };
      r.readAsText(f);
    });
  });

  slider.addEventListener('input', () => render(slider.value));

  document.getElementById('clearBtn').onclick = () => {
    allPoints=[]; dates=[];
    slider.disabled=true;
    label.textContent='ログ未読込';
    status.textContent='クリアしました';
    clearLayers(fogRects);
    clearLayers(clearRects);
    drawFog();
  };

  drawFog();
</script>

</body>
</html>
