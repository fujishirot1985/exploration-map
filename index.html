<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Exploration Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body {
      margin: 0;
      height: 100%;
      background: #111;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }

    #map {
      height: 80%;
    }

    #ui {
      height: 20%;
      padding: 10px 14px;
      background: #1a1a1a;
      color: #ddd;
      box-sizing: border-box;
    }

    .row {
      margin-bottom: 8px;
    }

    select,
    input[type="range"],
    input[type="text"],
    button {
      width: 100%;
      padding: 10px;
      background: #111;
      color: #ddd;
      border: 1px solid #333;
      border-radius: 8px;
      font-size: 14px;
      box-sizing: border-box;
    }

    input[type="range"] {
      width: 96%;
      margin: 0 auto;
      display: block;
      height: 28px;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #fff;
      border: none;
    }

    /* ===== ãƒ©ãƒ™ãƒ«ãƒ»æ™‚é–“è¡¨ç¤º ===== */

    #dateLabel {
      font-size: 14px;
      color: #fff;
      font-weight: bold;
    }

    #timeIcon {
      margin-right: 6px;
      font-size: 16px;
    }

    #status {
      font-size: 12px;
      color: #888;
    }

    /* ===== ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹è¡Œï¼ˆæ“ä½œè¡Œï¼‰ ===== */

    .row.flex {
      display: flex;
      gap: 8px;
      align-items: center;
      overflow: hidden; /* ã¯ã¿å‡ºã—é˜²æ­¢ */
    }

    /* iOS Safariå¯¾ç­–ï¼šç¸®ã‚“ã§OK */
    .row.flex select,
    .row.flex button {
      min-width: 0;
    }

    /* å˜ä½ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼šæœ€å° */
    .row.flex select.unitSmall {
      flex: 0 0 110px;
      padding-left: 6px;
      padding-right: 6px;
      text-align: center;
    }

    /* å˜ä½ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼šåºƒã‚ï¼ˆè¶³è·¡ä»¥å¤–ï¼‰ */
    .row.flex select.unitWide {
      flex: 0 0 200px;   /* â† è¦‹åˆ‡ã‚Œãªã„ã‚µã‚¤ã‚º */
      padding-left: 6px;
      padding-right: 6px;
      text-align: center;
    }

    /* ãƒ­ã‚°é¸æŠï¼šä¸»å½¹ */
    .row.flex select#dateSelect {
      flex: 1 1 auto;
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
    }

    /* é–‹å§‹åœ°ç‚¹ã¸ãƒœã‚¿ãƒ³ï¼šæ¨ªåºƒãƒ»1è¡Œ */
    .row.flex button#moveBtn {
      flex: 0 0 90px;
      white-space: nowrap;
      padding: 10px 8px;
    }

    /* ===== ãƒ¡ãƒ¢è¡¨ç¤º ===== */

    #memoInput {
      font-size: 15px;
      padding: 8px 10px;
      text-align: center;
      font-family:
        -apple-system,
        BlinkMacSystemFont,
        "Hiragino Maru Gothic ProN",
        "Hiragino Sans",
        sans-serif;
      background: #151515;
      border-color: #444;
    }

    /* ===== æ™‚é–“è¡Œ ===== */

    .timeRow {
      display: flex;
      align-items: center;
      gap: 6px;
    }
  </style>
</head>
<body>

<div id="map"></div>

<div id="ui">

  <!-- â‘  ãƒ¡ãƒ¢ï¼ˆæœ€ä¸Šæ®µï¼‰ -->
  <div class="row" id="memoRow" style="display:none;">
    <input
      type="text"
      id="memoInput"
      placeholder="ã“ã®æ•£æ­©ã®ãƒ¡ãƒ¢"
      readonly
    />
  </div>

  <!-- â‘¡ æ“ä½œè¡Œ -->
  <div class="row flex">
    <select id="unitSelect" class="unitSmall">
      <option value="minute">æ•£æ­©ã‚’è¿½ã†</option>
      <option value="day">æ•£æ­©ã‚³ãƒ¼ã‚¹ã‚’ã¿ã‚‹</option>
      <option value="day_sum">æ•£æ­©ã‚³ãƒ¼ã‚¹ã‚’é‡ã­ã‚‹</option>
      <!-- æœˆç³»ã¯ã„ã£ãŸã‚“æ¶ˆã™ -->
      <!--
      <option value="month">ã“ã‚Œã¾ã§ã®æ•£æ­©ã‚³ãƒ¼ã‚¹</option>
      <option value="month_sum">ã“ã‚Œã¾ã§ã„ã£ãŸã¨ã“ã‚</option>
      -->
    </select>

    <select id="dateSelect" disabled>
      <option value="">ãƒ­ã‚°ã‚’é¸æŠ</option>
    </select>

    <button id="moveBtn" disabled>é–‹å§‹åœ°ç‚¹ã¸</button>
  </div>

  <!-- â‘¢ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ -->
  <div class="row">
    <input type="range" id="timeSlider" min="0" max="0" value="0" disabled />
  </div>

  <!-- â‘£ æ™‚é–“è¡¨ç¤º -->
  <div class="row timeRow">
    <span id="timeIcon"></span>
    <span id="dateLabel">èª­ã¿è¾¼ã¿ä¸­â€¦</span>
  </div>

  <div id="status">ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™</div>
</div>

<script>
  const GAS_URL = "https://script.google.com/macros/s/AKfycbyueOmlLN-2vDHQcrjTIOBAGYMAQy-Vnd1DdXgYezd2mZ-RQ9m2LHySWdz3ox5-NpIa/exec";

  const map = L.map('map', { preferCanvas: true })
    .setView([35.7216, 140.1555], 15);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap'
  }).addTo(map);

  let allPoints = [];
  let timeBuckets = [];
  let footprintMarkers = [];
  let selectedDate = null;

  let logs = [];
  let selectedLogId = "";

  let autoPanned = false;

  const slider = document.getElementById('timeSlider');
  const label  = document.getElementById('dateLabel');
  const timeIcon = document.getElementById('timeIcon');
  const status = document.getElementById('status');
  const unitSelect = document.getElementById('unitSelect');
  const dateSelect = document.getElementById('dateSelect');
  const moveBtn = document.getElementById('moveBtn');
  const memoRow = document.getElementById('memoRow');
  const memoInput = document.getElementById('memoInput');

  function clearLayers(arr) {
    arr.forEach(l => map.removeLayer(l));
    arr.length = 0;
  }

  function localDateString(iso) {
    const d = new Date(iso);
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }

  function makeTimeKey(iso, unit) {
    const d = new Date(iso);
    if (unit === 'minute') d.setSeconds(0, 0);
    if (unit === 'hour')   d.setMinutes(0, 0, 0);
    if (unit === 'day' || unit === 'day_sum') d.setHours(0, 0, 0, 0);
    if (unit === 'month' || unit === 'month_sum') {
      d.setDate(1); d.setHours(0, 0, 0, 0);
    }
    return d.toISOString();
  }

  function buildBuckets(unit, points = allPoints) {
    const mapBuckets = new Map();
    points.forEach(p => {
      const key = makeTimeKey(p.time, unit);
      if (!mapBuckets.has(key)) mapBuckets.set(key, []);
      mapBuckets.get(key).push(p);
    });
    return Array.from(mapBuckets.entries()).sort((a, b) => a[0].localeCompare(b[0]));
  }

  const footprintSvg =
  '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">' +

    // --- ãƒãƒ­ãƒ¼ï¼ˆå¤–å´ï¼‰ ---
    '<circle cx="6"  cy="7"  r="2.8" fill="rgba(255,255,255,0.8)"/>' +
    '<circle cx="10" cy="5"  r="2.8" fill="rgba(255,255,255,0.8)"/>' +
    '<circle cx="14" cy="5"  r="2.8" fill="rgba(255,255,255,0.8)"/>' +
    '<circle cx="18" cy="7"  r="2.8" fill="rgba(255,255,255,0.8)"/>' +
    '<ellipse cx="12" cy="14" rx="5.8" ry="4.6" fill="rgba(255,255,255,0.8)"/>' +

    // --- æœ¬ä½“ï¼ˆå†…å´ï¼‰ ---
    '<circle cx="6"  cy="7"  r="2" fill="#444"/>' +
    '<circle cx="10" cy="5"  r="2" fill="#444"/>' +
    '<circle cx="14" cy="5"  r="2" fill="#444"/>' +
    '<circle cx="18" cy="7"  r="2" fill="#444"/>' +
    '<ellipse cx="12" cy="14" rx="5" ry="4" fill="#444"/>' +

  '</svg>';

  function colorFromDayKey(dayKey) {
    let hash = 0;
    for (let i = 0; i < dayKey.length; i++) {
      hash = (hash << 5) - hash + dayKey.charCodeAt(i);
      hash |= 0;
    }
    const hue = Math.abs(hash) % 360;
    return `hsl(${hue}, 40%, 45%)`;
  }

  function distance(a, b) {
    const R = 6371000;
    const toRad = x => x * Math.PI / 180;
    const dLat = toRad(b.lat - a.lat);
    const dLng = toRad(b.lng - a.lng);
    const s =
      Math.sin(dLat/2)**2 +
      Math.cos(toRad(a.lat)) * Math.cos(toRad(b.lat)) *
      Math.sin(dLng/2)**2;
    return 2 * R * Math.asin(Math.sqrt(s));
  }

  function areaRadiusByZoom(zoom) {
    if (zoom >= 14) return 400;
    if (zoom >= 13) return 550;
    if (zoom >= 12) return 800;
    if (zoom >= 11) return 1200;
    if (zoom >= 10) return 1600;
    if (zoom >= 9)  return 2200;
    return 3000;
  }

  function timeIconFromHour(h) {
    if (h >= 5 && h < 9)  return "ğŸŒ…";
    if (h >= 9 && h < 16) return "â˜€ï¸";
    if (h >= 16 && h < 19) return "ğŸŒ†";
    return "ğŸŒ™";
  }

  function render(index) {
    clearLayers(footprintMarkers);

    const unit = unitSelect.value;
    const isCumulative =
      unit === 'minute' ||
      unit === 'hour' ||
      unit === 'day_sum' ||
      unit === 'month_sum';

    const visible = isCumulative
      ? timeBuckets.slice(0, index + 1)
      : [timeBuckets[index]];

    const zoom = map.getZoom();
    const isRouteScale = zoom >= 14;

    const FOOTPRINT_INTERVAL = 60 * 1000;
    const AREA_RADIUS = areaRadiusByZoom(zoom);

    let lastTime = null;

    visible.forEach(([dayKey, pts]) => {
      const sorted = pts.slice().sort(
        (a, b) => new Date(a.time) - new Date(b.time)
      );

      const color =
        unit === 'day_sum'
          ? colorFromDayKey(dayKey)
          : '#444';

      const icon = L.icon({
        iconUrl:
          'data:image/svg+xml;base64,' +
          btoa(footprintSvg.replace(/fill="#444"/g, `fill="${color}"`)),
        iconSize: [18, 18],
        iconAnchor: [9, 9]
      });

      if (isRouteScale) {
        sorted.forEach(p => {
          const t = new Date(p.time).getTime();
          if (!lastTime || t - lastTime >= FOOTPRINT_INTERVAL) {
            lastTime = t;
            footprintMarkers.push(
              L.marker([p.lat, p.lng], { icon, interactive:false }).addTo(map)
            );
          }
        });
      } else {
        const areas = [];
        sorted.forEach(p => {
          let placed = false;
          for (const a of areas) {
            if (distance(a, p) <= AREA_RADIUS) {
              a.lat = (a.lat * a.count + p.lat) / (a.count + 1);
              a.lng = (a.lng * a.count + p.lng) / (a.count + 1);
              a.count++;
              placed = true;
              break;
            }
          }
          if (!placed) areas.push({ lat:p.lat, lng:p.lng, count:1 });
        });

        areas.forEach(a => {
          footprintMarkers.push(
            L.marker([a.lat, a.lng], { icon, interactive:false }).addTo(map)
          );
        });
      }
    });

    label.textContent = formatLabel(timeBuckets[index][0], unit);

    // ===== è¶³è·¡ãŒç”»é¢å¤–ã«å‡ºãŸã‚‰1å›ã ã‘å¯„ã›ã‚‹ =====
    const lastBucket = timeBuckets[index];
    if (lastBucket) {
      const pts = lastBucket[1];
      if (pts && pts.length) {
        const last = pts[pts.length - 1];
        const latlng = L.latLng(last.lat, last.lng);

        const inView = map.getBounds().contains(latlng);

        if (!inView && !autoPanned) {
          map.panTo(latlng, { animate: true });
          autoPanned = true;
        }

        // â˜… ç”»é¢å†…ã«æˆ»ã£ãŸã‚‰ã€æ¬¡ã®è‡ªå‹•å¯„ã›ã‚’è¨±å¯
        if (inView) {
          autoPanned = false;
        }
      }
    }
  }

  function buildDateSelectForDates() {
    dateSelect.innerHTML = '<option value="">æ—¥ä»˜ã‚’é¸æŠ</option>';
    const set = new Set();
    allPoints.forEach(p => set.add(localDateString(p.time)));
    Array.from(set).sort().forEach(d => {
      const opt = document.createElement('option');
      opt.value = d;
      opt.textContent = d;
      dateSelect.appendChild(opt);
    });
  }

  function buildDateSelectForLogs() {
    dateSelect.innerHTML = '<option value="">ãƒ­ã‚°ã‚’é¸æŠ</option>';
    logs.forEach(l => {
      const d = new Date(l.startIso);
      const opt = document.createElement('option');
      opt.value = l.id;
      opt.textContent =
        `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}ã€œ`;
      dateSelect.appendChild(opt);
    });
    if (selectedLogId) dateSelect.value = selectedLogId;
  }

  function moveToSelectedLog() {
    const log = logs.find(l => l.id === selectedLogId);
    if (!log) return;
    map.setView(log.firstLatLng, map.getZoom(), { animate: true });
  }

  function rebuild() {
    const unit = unitSelect.value;
    const logMode = unit === 'minute';

    unitSelect.classList.toggle("unitWide", !logMode);
    unitSelect.classList.toggle("unitSmall", logMode);

    // è¶³è·¡ãƒ¢ãƒ¼ãƒ‰ä»¥å¤–ã§ã¯ãƒ­ã‚°æ“ä½œUIã‚’éš ã™
    dateSelect.style.display = logMode ? "" : "none";
    moveBtn.style.display   = logMode ? "" : "none";

    autoPanned = false;

    dateSelect.disabled = !(unit === 'minute' || unit === 'hour');
    moveBtn.disabled = !(logMode && selectedLogId);

    let targetPoints = allPoints;

    memoRow.style.display = (logMode && selectedLogId) ? "block" : "none";

    if (logMode) {
      buildDateSelectForLogs();
      if (selectedLogId) {
        const log = logs.find(l => l.id === selectedLogId);
        if (log) {
          targetPoints = log.points;
          timeIcon.textContent =
            timeIconFromHour(new Date(log.startIso).getHours());
          memoInput.value = log.note || "";
        }
      } else {
        targetPoints = [];
        timeIcon.textContent = "";
        memoInput.value = "";
      }
    } else if (unit === 'hour') {
      buildDateSelectForDates();
      if (selectedDate) {
        targetPoints = allPoints.filter(p => localDateString(p.time) === selectedDate);
      }
      timeIcon.textContent = "";
      memoInput.value = "";
    } else {
      timeIcon.textContent = "";
      memoInput.value = "";
    }

    timeBuckets = buildBuckets(unit, targetPoints);

    if (!timeBuckets.length) {
      slider.disabled = true;
      label.textContent = 'ãƒ­ã‚°ãªã—';
      clearLayers(footprintMarkers);
      return;
    }

    slider.min = 0;
    slider.max = timeBuckets.length - 1;
    slider.value = 0;
    slider.disabled = false;

    render(slider.value);
  }

  async function loadFromGAS() {
    const res = await fetch(GAS_URL);
    const files = await res.json();

    allPoints = [];
    logs = [];

    files.forEach((f, idx) => {
      const pts = parseGPX(f.content);
      if (!pts.length) return;

      pts.sort((a, b) => new Date(a.time) - new Date(b.time));
      allPoints.push(...pts);

      logs.push({
        id: `log_${idx}`,
        startIso: pts[0].time,
        points: pts,
        firstLatLng: [pts[0].lat, pts[0].lng],
        note: f.note || ""
      });
    });

    logs.sort((a, b) => new Date(a.startIso) - new Date(b.startIso));
    status.textContent = `${files.length}ãƒ•ã‚¡ã‚¤ãƒ« / ${allPoints.length}ç‚¹`;
    rebuild();
  }

  function parseGPX(text) {
    const pts = [];
    const xml = new DOMParser().parseFromString(text, "application/xml");
    const trkpts = xml.getElementsByTagName("trkpt");
    for (let i = 0; i < trkpts.length; i++) {
      const lat = parseFloat(trkpts[i].getAttribute("lat"));
      const lng = parseFloat(trkpts[i].getAttribute("lon"));
      const timeEl = trkpts[i].getElementsByTagName("time")[0];
      if (timeEl) pts.push({ lat, lng, time: timeEl.textContent });
    }
    return pts;
  }

  function formatLabel(dateIso, unit) {
    const d = new Date(dateIso);

    if (unit === "day" || unit === "day_sum") {
      // æ—¥å˜ä½ï¼šæ—¥ä»˜ã®ã¿
      return d.toLocaleDateString();
    }

    if (unit === "month" || unit === "month_sum") {
      // æœˆå˜ä½ï¼šå¹´æœˆã®ã¿
      return `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ`;
    }

    // è¶³è·¡ã‚’è¿½ã†ï¼ˆminuteï¼‰ï¼šæ—¥æ™‚
    return d.toLocaleString();
  }

  slider.addEventListener('input', () => render(Number(slider.value)));
  unitSelect.addEventListener('change', () => {
    if (unitSelect.value !== 'minute') selectedLogId = "";
    rebuild();
  });
  dateSelect.addEventListener('change', () => {
    if (unitSelect.value === 'minute') {
      selectedLogId = dateSelect.value;
      // â˜… ãƒ­ã‚°é¸æŠã¨åŒæ™‚ã«é–‹å§‹åœ°ç‚¹ã¸
      if (selectedLogId) {
        moveToSelectedLog();
      }
    } else {
      selectedDate = dateSelect.value;
    }
    rebuild();
  });
  moveBtn.addEventListener('click', moveToSelectedLog);
  map.on('zoomend', () => {
    if (!slider.disabled) render(Number(slider.value));
  });

  loadFromGAS();
</script>

</body>
</html>
