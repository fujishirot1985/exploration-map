<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Fog Map – Farther Walk Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
  </script>

  <style>
    html, body {
      margin: 0;
      height: 100%;
      background: #111;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }
    #map { height: 88%; }
    #ui {
      height: 12%;
      padding: 12px 16px;
      background: #1a1a1a;
      color: #ccc;
      box-sizing: border-box;
    }
    #monthLabel {
      font-size: 14px;
      margin-top: 4px;
    }
    input[type=range] { width: 100%; }
  </style>
</head>
<body>

<div id="map"></div>

<div id="ui">
  <input type="range" min="5" max="7" value="6" id="slider">
  <div id="monthLabel">6月</div>
</div>

<script>
  // ===== 起点
  const CENTER_LAT = 35.721625;
  const CENTER_LNG = 140.155500;

  const map = L.map('map', { zoomControl: false })
    .setView([CENTER_LAT, CENTER_LNG], 15);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap'
  }).addTo(map);

  // ===== グリッド
  const GRID_LAT = 0.00012;
  const GRID_LNG = 0.00035;

  function gridKey(lat, lng) {
    const x = Math.floor(lat / GRID_LAT);
    const y = Math.floor(lng / GRID_LNG);
    return `${x}_${y}`;
  }

  function gridBounds(key) {
    const [x, y] = key.split('_').map(Number);
    const lat1 = x * GRID_LAT;
    const lng1 = y * GRID_LNG;
    const lat2 = lat1 + GRID_LAT;
    const lng2 = lng1 + GRID_LNG;
    return [[lat1, lng1], [lat2, lng2]];
  }

  // ===== 月ごとに方向＋半径をさらに拡張
  const monthData = {
    // --- 5月：西・北にかなり遠出
    5: [
      [35.7216,140.1551],[35.7216,140.1547],[35.7216,140.1543],
      [35.7220,140.1545],[35.7224,140.1545],
      [35.7227,140.1548],

      // さらに西北へ
      [35.7231,140.1540],[35.7235,140.1532],
      [35.7239,140.1524]
    ],

    // --- 6月：東方向に大きく伸びる
    6: [
      // 起点〜生活圏
      [35.7216,140.1551],[35.7216,140.1554],[35.7216,140.1557],
      [35.7213,140.1554],[35.7219,140.1554],

      // 東西幹線
      [35.7216,140.1548],[35.7216,140.1551],[35.7216,140.1554],
      [35.7216,140.1557],[35.7216,140.1560],[35.7216,140.1563],
      [35.7216,140.1566],[35.7216,140.1569],

      // 東へ遠出（さらに倍）
      [35.7216,140.1573],[35.7216,140.1578],[35.7216,140.1583],
      [35.7216,140.1588],[35.7216,140.1593],
      [35.7219,140.1598],[35.7222,140.1603]
    ],

    // --- 7月：南東にかなり冒険
    7: [
      // 東南方向
      [35.7216,140.1568],[35.7216,140.1573],[35.7216,140.1578],
      [35.7212,140.1583],[35.7208,140.1588],
      [35.7204,140.1593],[35.7200,140.1598],

      // さらに南へ
      [35.7196,140.1602],[35.7192,140.1606]
    ]
  };

  let fogRects = [];
  let clearRects = [];

  function clearAll() {
    fogRects.forEach(r => map.removeLayer(r));
    clearRects.forEach(r => map.removeLayer(r));
    fogRects = [];
    clearRects = [];
  }

  function drawFog() {
    const bounds = map.getBounds();
    const latMin = bounds.getSouth();
    const latMax = bounds.getNorth();
    const lngMin = bounds.getWest();
    const lngMax = bounds.getEast();

    const xStart = Math.floor(latMin / GRID_LAT);
    const xEnd   = Math.floor(latMax / GRID_LAT);
    const yStart = Math.floor(lngMin / GRID_LNG);
    const yEnd   = Math.floor(lngMax / GRID_LNG);

    for (let x = xStart; x <= xEnd; x++) {
      for (let y = yStart; y <= yEnd; y++) {
        const rect = L.rectangle(
          [[x * GRID_LAT, y * GRID_LNG],
           [(x + 1) * GRID_LAT, (y + 1) * GRID_LNG]],
          {
            color: null,
            fillColor: '#0e0e11',
            fillOpacity: 0.45,
            weight: 0
          }
        ).addTo(map);
        fogRects.push(rect);
      }
    }
  }

  function drawCleared(month) {
    const months = [month - 1, month, month + 1];

    months.forEach(m => {
      if (!monthData[m]) return;

      const countMap = new Map();
      monthData[m].forEach(([lat, lng]) => {
        const key = gridKey(lat, lng);
        countMap.set(key, (countMap.get(key) || 0) + 1);
      });

      countMap.forEach((count, key) => {
        let opacity;
        if (m === month) {
          opacity = (count >= 2) ? 0.45 : 0.30;
        } else {
          opacity = 0.16;
        }

        const rect = L.rectangle(gridBounds(key), {
          color: null,
          fillColor: '#ffffff',
          fillOpacity: opacity,
          weight: 0
        }).addTo(map);

        clearRects.push(rect);
      });
    });
  }

  function render(month) {
    clearAll();
    drawFog();
    drawCleared(month);
  }

  const slider = document.getElementById('slider');
  const label = document.getElementById('monthLabel');

  slider.addEventListener('input', () => {
    const m = Number(slider.value);
    label.textContent = `${m}月`;
    render(m);
  });

  render(6);
</script>

</body>
</html>
