<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Exploration Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body {
      margin: 0;
      height: 100%;
      background: #111;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }

    #map { height: 80%; }

    #ui {
      height: 20%;
      padding: 10px 14px;
      background: #1a1a1a;
      color: #ddd;
      box-sizing: border-box;
    }

    .row { margin-bottom: 8px; }

    select,
    input[type="range"],
    button {
      width: 100%;
      padding: 10px;
      background: #111;
      color: #ddd;
      border: 1px solid #333;
      border-radius: 8px;
      font-size: 14px;
      box-sizing: border-box;
    }

    input[type="range"] {
      width: 96%;
      margin: 0 auto;
      display: block;
      height: 28px;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #fff;
      border: none;
    }

    #dateLabel {
      font-size: 14px;
      color: #fff;
      font-weight: bold;
    }

    #timeIcon { margin-right: 6px; font-size: 16px; }
    #status { font-size: 12px; color: #888; }

    .row.flex {
      display: flex;
      gap: 8px;
      align-items: center;
      overflow: hidden;
    }

    .row.flex > * { min-width: 0; }

    /* 2è¡Œç›®ï¼šå†ç”Ÿ/åœæ­¢ + ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    button#playBtn { flex: 0 0 120px; }
    button#stopBtn { flex: 0 0 80px;  opacity: 0.95; }

    /* 1è¡Œç›®ï¼šãƒ­ã‚°é¸æŠã‚’æœ€å„ªå…ˆã§çœç•¥è¡¨ç¤º */
    select#dateSelect {
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
    }

    .timeRow {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* ===== è¿½åŠ ï¼šã‚¤ãƒ™ãƒ³ãƒˆã‚¢ã‚¤ã‚³ãƒ³ ===== */
    .eventIcon {
      font-size: 18px;
      line-height: 18px;
      transform: translateY(-2px);
      filter: drop-shadow(0 1px 2px rgba(0,0,0,0.65));
      opacity: 0.95;
      user-select: none;
    }

    /* ===== è¿½åŠ ï¼šãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®é›°å›²æ°— ===== */
    .evtPopup {
      font-size: 12px;
      color: #eee;
      background: rgba(20,20,20,0.92);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 10px;
      padding: 8px 10px;
      max-width: 220px;
      animation: fadeIn 0.22s ease-out forwards;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .leaflet-popup-content-wrapper { background: transparent; box-shadow: none; }
    .leaflet-popup-tip { background: rgba(20,20,20,0.92); }
  </style>
</head>
<body>

<div id="map"></div>

<div id="ui">
  <!-- 1è¡Œç›®ï¼šãƒ­ã‚°é¸æŠï¼ˆå›ºå®šï¼‰ -->
  <div class="row">
    <select id="dateSelect" disabled>
      <option value="">ãƒ­ã‚°ã‚’é¸æŠ</option>
    </select>
  </div>

  <!-- 2è¡Œç›®ï¼šå†ç”Ÿ/åœæ­¢ + ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠï¼ˆå›ºå®šï¼‰ -->
  <div class="row flex">
    <button id="playBtn" disabled>ã‚†ã£ãã‚Šå†ç”Ÿ</button>
    <button id="stopBtn" disabled>åœæ­¢</button>
  </div>

  <!-- 3è¡Œç›®ï¼šã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼ˆå›ºå®šï¼‰ -->
  <div class="row">
    <input type="range" id="timeSlider" min="0" max="0" value="0" disabled />
  </div>

  <!-- 4è¡Œç›®ï¼šæ™‚åˆ»ãƒ©ãƒ™ãƒ«ï¼ˆè£œè¶³æƒ…å ±ï¼‰ -->
  <div class="row timeRow">
    <span id="timeIcon"></span>
    <span id="dateLabel">èª­ã¿è¾¼ã¿ä¸­â€¦</span>
  </div>

  <div id="status">ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™</div>
</div>

<script>
  const GAS_URL = "https://script.google.com/macros/s/AKfycbyueOmlLN-2vDHQcrjTIOBAGYMAQy-Vnd1DdXgYezd2mZ-RQ9m2LHySWdz3ox5-NpIa/exec";

  const map = L.map('map', { preferCanvas: true })
    .setView([35.7216, 140.1555], 15);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap'
  }).addTo(map);

  let allPoints = [];
  let timeBuckets = [];
  let footprintMarkers = [];
  let eventMarkers = [];

  let logs = [];
  let selectedLogId = "";

  let autoPanned = false;

  // ===== å†ç”ŸçŠ¶æ…‹ =====
  let playTimer = null;
  let isPlaying = false;
  let lastAutoPopupAt = 0;

  // ===== ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ€ãƒŸãƒ¼ï¼‰ =====
  let currentEvents = [];

  const slider = document.getElementById('timeSlider');
  const label  = document.getElementById('dateLabel');
  const timeIcon = document.getElementById('timeIcon');
  const status = document.getElementById('status');
  const dateSelect = document.getElementById('dateSelect');

  const playBtn = document.getElementById('playBtn');
  const stopBtn = document.getElementById('stopBtn');

  function clearLayers(arr) {
    arr.forEach(l => map.removeLayer(l));
    arr.length = 0;
  }

  function localDateString(iso) {
    const d = new Date(iso);
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }

  function makeTimeKey(iso, unit) {
    const d = new Date(iso);
    if (unit === 'minute') d.setSeconds(0, 0);
    if (unit === 'hour')   d.setMinutes(0, 0, 0);
    if (unit === 'day' || unit === 'day_sum') d.setHours(0, 0, 0, 0);
    if (unit === 'month' || unit === 'month_sum') {
      d.setDate(1); d.setHours(0, 0, 0, 0);
    }
    return d.toISOString();
  }

  function buildBuckets(unit, points = allPoints) {
    const mapBuckets = new Map();
    points.forEach(p => {
      const key = makeTimeKey(p.time, unit);
      if (!mapBuckets.has(key)) mapBuckets.set(key, []);
      mapBuckets.get(key).push(p);
    });
    return Array.from(mapBuckets.entries()).sort((a, b) => a[0].localeCompare(b[0]));
  }

  const footprintSvg =
  '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">' +
    '<circle cx="6"  cy="7"  r="2.8" fill="rgba(255,255,255,0.8)"/>' +
    '<circle cx="10" cy="5"  r="2.8" fill="rgba(255,255,255,0.8)"/>' +
    '<circle cx="14" cy="5"  r="2.8" fill="rgba(255,255,255,0.8)"/>' +
    '<circle cx="18" cy="7"  r="2.8" fill="rgba(255,255,255,0.8)"/>' +
    '<ellipse cx="12" cy="14" rx="5.8" ry="4.6" fill="rgba(255,255,255,0.8)"/>' +
    '<circle cx="6"  cy="7"  r="2" fill="#444"/>' +
    '<circle cx="10" cy="5"  r="2" fill="#444"/>' +
    '<circle cx="14" cy="5"  r="2" fill="#444"/>' +
    '<circle cx="18" cy="7"  r="2" fill="#444"/>' +
    '<ellipse cx="12" cy="14" rx="5" ry="4" fill="#444"/>' +
  '</svg>';

  function distance(a, b) {
    const R = 6371000;
    const toRad = x => x * Math.PI / 180;
    const dLat = toRad(b.lat - a.lat);
    const dLng = toRad(b.lng - a.lng);
    const s =
      Math.sin(dLat/2)**2 +
      Math.cos(toRad(a.lat)) * Math.cos(toRad(b.lat)) *
      Math.sin(dLng/2)**2;
    return 2 * R * Math.asin(Math.sqrt(s));
  }

  function areaRadiusByZoom(zoom) {
    if (zoom >= 14) return 400;
    if (zoom >= 13) return 550;
    if (zoom >= 12) return 800;
    if (zoom >= 11) return 1200;
    if (zoom >= 10) return 1600;
    if (zoom >= 9)  return 2200;
    return 3000;
  }

  function timeIconFromHour(h) {
    if (h >= 5 && h < 9)  return "ğŸŒ…";
    if (h >= 9 && h < 16) return "â˜€ï¸";
    if (h >= 16 && h < 19) return "ğŸŒ†";
    return "ğŸŒ™";
  }

  function escapeHtml(str) {
    return String(str)
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;');
  }

  function makeEventDivIcon(type) {
    const html = type === 'memo' ? 'ğŸ’¬' : 'ğŸ“·';
    return L.divIcon({
      className: '',
      html: `<div class="eventIcon">${html}</div>`,
      iconSize: [20, 20],
      iconAnchor: [10, 10]
    });
  }

  function showEventPopup(latlng, content, autoCloseMs = 0) {
    const now = Date.now();
    if (autoCloseMs > 0 && now - lastAutoPopupAt < 450) return;
    if (autoCloseMs > 0) lastAutoPopupAt = now;

    const popup = L.popup({ closeButton: false, autoClose: true, closeOnClick: true })
      .setLatLng(latlng)
      .setContent(`<div class="evtPopup">${escapeHtml(content)}</div>`)
      .openOn(map);

    if (autoCloseMs > 0) {
      setTimeout(() => {
        try { map.closePopup(popup); } catch(e) {}
      }, autoCloseMs);
    }
  }

  function buildDummyEventsForLog(log) {
    if (!log || !log.points || log.points.length < 5) return [];
    const n = log.points.length;
    const i1 = Math.max(1, Math.floor(n * 0.30));
    const i2 = Math.max(2, Math.floor(n * 0.70));

    const p1 = log.points[i1];
    const p2 = log.points[i2];

    return [
      {
        id: 'evt_memo_1',
        type: 'memo',
        latlng: [p1.lat, p1.lng],
        content: 'ï¼ˆãƒ€ãƒŸãƒ¼ï¼‰ã“ã“ã§ãƒ¡ãƒ¢ï¼šãƒ‘ãƒ³å±‹ãŒè‰¯ã‹ã£ãŸ',
        fired: false
      },
      {
        id: 'evt_photo_1',
        type: 'photo',
        latlng: [p2.lat, p2.lng],
        content: 'ï¼ˆãƒ€ãƒŸãƒ¼ï¼‰ã“ã“ã§å†™çœŸï¼šå¤•ç„¼ã‘ãŒãã‚Œã„ã ã£ãŸ',
        fired: false
      }
    ];
  }

  function formatLabel(dateIso, unit) {
    const d = new Date(dateIso);
    if (unit === "day" || unit === "day_sum") return d.toLocaleDateString();
    if (unit === "month" || unit === "month_sum") return `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ`;
    return d.toLocaleString();
  }

  function stopPlayback() {
    if (playTimer) {
      clearInterval(playTimer);
      playTimer = null;
    }
    isPlaying = false;
    playBtn.textContent = "ã‚†ã£ãã‚Šå†ç”Ÿ";
  }

  function startPlayback() {
    const unit = 'minute';
    if (!(unit === 'minute' && selectedLogId)) return;
    if (isPlaying) return;

    slider.value = 0;
    currentEvents.forEach(e => e.fired = false);

    isPlaying = true;
    playBtn.textContent = "å†ç”Ÿä¸­â€¦";

    const stepMs = 900;
    playTimer = setInterval(() => {
      const v = Number(slider.value);
      const max = Number(slider.max);

      if (v >= max) {
        stopPlayback();
        return;
      }

      autoPanned = false;
      slider.value = String(v + 1);
      render(Number(slider.value));
    }, stepMs);
  }

  function render(index) {
    clearLayers(footprintMarkers);
    clearLayers(eventMarkers);

    const unit = 'minute';
    const isMinuteMode = (unit === 'minute' && selectedLogId);
    const isPlayback = isMinuteMode && isPlaying;

    const isCumulative =
      unit === 'minute' ||
      unit === 'hour' ||
      unit === 'day_sum' ||
      unit === 'month_sum';

    const visible = isCumulative
      ? timeBuckets.slice(0, index + 1)
      : [timeBuckets[index]];

    const zoom = map.getZoom();
    const isRouteScale = zoom >= 14;

    const FOOTPRINT_INTERVAL = 60 * 1000;
    const THIN_BY_DISTANCE = areaRadiusByZoom(zoom);

    const allVisiblePoints = [];
    visible.forEach(([_, pts]) => {
      const sorted = pts.slice().sort((a, b) => new Date(a.time) - new Date(b.time));
      sorted.forEach(p => allVisiblePoints.push(p));
    });

    const placed = [];
    let lastPlacedTime = null;
    let lastPlacedLatLng = null;

    allVisiblePoints.forEach(p => {
      const t = new Date(p.time).getTime();

      if (isRouteScale) {
        if (lastPlacedTime && t - lastPlacedTime < FOOTPRINT_INTERVAL) return;
        lastPlacedTime = t;
      }

      const latlng = { lat: p.lat, lng: p.lng };
      if (lastPlacedLatLng) {
        const d = distance(lastPlacedLatLng, latlng);
        if (!isRouteScale && d < THIN_BY_DISTANCE) return;
        if (isRouteScale && d < 8) return;
      }

      lastPlacedLatLng = latlng;
      placed.push(latlng);
    });

    const baseIcon = L.icon({
      iconUrl: 'data:image/svg+xml;base64,' + btoa(footprintSvg),
      iconSize: [18, 18],
      iconAnchor: [9, 9]
    });

    placed.forEach((p, idx) => {
      let opacity = 1.0;
      if (isPlayback) {
        const d = placed.length - 1 - idx;
        if (d === 0) opacity = 1.00;
        else if (d === 1) opacity = 0.65;
        else if (d === 2) opacity = 0.40;
        else opacity = 0.25;
      }

      footprintMarkers.push(
        L.marker([p.lat, p.lng], { icon: baseIcon, interactive: false, opacity }).addTo(map)
      );
    });

    label.textContent = formatLabel(timeBuckets[index][0], unit);

    if (isMinuteMode && currentEvents.length) {
      currentEvents.forEach(e => {
        const marker = L.marker(e.latlng, {
          icon: makeEventDivIcon(e.type),
          interactive: true
        }).addTo(map);

        eventMarkers.push(marker);

        marker.on('click', () => {
          showEventPopup(e.latlng, e.content, 0);
        });
      });
    }

    const lastPlaced = placed.length ? placed[placed.length - 1] : null;
    if (lastPlaced) {
      const bounds = map.getBounds();
      const padded = bounds.pad(-0.15); // ç”»é¢å†…å´15%
      const lastLatLng = L.latLng(lastPlaced.lat, lastPlaced.lng);

      if (!padded.contains(lastLatLng) && !autoPanned) {
        const zoom = map.getZoom();
        const p = map.project(lastLatLng, zoom);
        p.y += 80; // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ä½™ç™½

        map.panTo(map.unproject(p, zoom), { animate: true });
        autoPanned = true;
      }
    }

    if (isMinuteMode && currentEvents.length && lastPlaced) {
      currentEvents.forEach(e => {
        if (e.fired) return;
        const d = distance(lastPlaced, { lat: e.latlng[0], lng: e.latlng[1] });
        if (d < 30) {
          e.fired = true;
          showEventPopup(e.latlng, e.content, 2200);
        }
      });
    }
  }

  function buildLogSelect() {
    dateSelect.innerHTML = '<option value="">ãƒ­ã‚°ã‚’é¸æŠ</option>';

    logs.forEach(l => {
      const d = new Date(l.startIso);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      const hh = String(d.getHours()).padStart(2,'0');
      const mi = String(d.getMinutes()).padStart(2,'0');

      const note = (l.note || "").trim();
      const title = note ? note : "ï¼ˆãƒ¡ãƒ¢ãªã—ï¼‰";

      const opt = document.createElement('option');
      opt.value = l.id;
      opt.textContent = `${yyyy}-${mm}-${dd} ${hh}:${mi}  ${title}`;
      dateSelect.appendChild(opt);
    });

    if (selectedLogId) dateSelect.value = selectedLogId;
  }

  function jumpToSelectedLogStart() {
    const log = logs.find(l => l.id === selectedLogId);
    if (!log) return;
    map.setView(log.firstLatLng, map.getZoom(), { animate: true });
  }

  function updatePlayButtonsState() {
    const canPlay = !!selectedLogId;
    playBtn.disabled = !canPlay;
    stopBtn.disabled = !canPlay;
    if (!canPlay) stopPlayback();
  }

  function rebuild() {
    stopPlayback();
    autoPanned = false;

    buildLogSelect();
    updatePlayButtonsState();

    const unit = 'minute';

    // è¡¨ç¤ºå¯¾è±¡ãƒã‚¤ãƒ³ãƒˆï¼ˆunit ã«å¿œã˜ã¦ï¼‰
    let targetPoints = [];

    if (unit === 'minute') {
      if (selectedLogId) {
        const log = logs.find(l => l.id === selectedLogId);
        if (log) {
          targetPoints = log.points;
          timeIcon.textContent = timeIconFromHour(new Date(log.startIso).getHours());
          currentEvents = buildDummyEventsForLog(log);
        }
      } else {
        timeIcon.textContent = "";
        currentEvents = [];
      }
    } else if (unit === 'day') {
      // å…¨ä½“ã®ã€Œæ—¥ã€åˆ‡ã‚Šæ›¿ãˆï¼ˆãƒ­ã‚°æŒ‡å®šã¯ä½¿ã‚ãšå…¨ãƒ­ã‚°åˆ†ï¼‰
      targetPoints = allPoints;
      timeIcon.textContent = "";
      currentEvents = [];
    } else if (unit === 'day_sum') {
      targetPoints = allPoints;
      timeIcon.textContent = "";
      currentEvents = [];
    } else {
      targetPoints = allPoints;
      timeIcon.textContent = "";
      currentEvents = [];
    }

    timeBuckets = buildBuckets(unit, targetPoints);

    if (!timeBuckets.length) {
      slider.disabled = true;
      slider.min = 0;
      slider.max = 0;
      slider.value = 0;
      label.textContent = 'ãƒ­ã‚°ãªã—';
      clearLayers(footprintMarkers);
      clearLayers(eventMarkers);
      return;
    }

    slider.min = 0;
    slider.max = timeBuckets.length - 1;
    slider.disabled = false;

    // minute+ãƒ­ã‚°é¸æŠæ™‚ã¯ã€Œä¸€æšçµµã€ã‹ã‚‰ï¼ˆæœ«å°¾ï¼‰
    if (unit === 'minute' && selectedLogId) slider.value = String(slider.max);
    else slider.value = "0";

    render(Number(slider.value));
  }

  async function loadFromGAS() {
    const res = await fetch(GAS_URL);
    const files = await res.json();

    allPoints = [];
    logs = [];

    files.forEach((f, idx) => {
      const pts = parseGPX(f.content);
      if (!pts.length) return;

      pts.sort((a, b) => new Date(a.time) - new Date(b.time));
      allPoints.push(...pts);

      logs.push({
        id: `log_${idx}`,
        startIso: pts[0].time,
        points: pts,
        firstLatLng: [pts[0].lat, pts[0].lng],
        note: f.note || ""
      });
    });

    logs.sort((a, b) => new Date(a.startIso) - new Date(b.startIso));

    status.textContent = `${files.length}ãƒ•ã‚¡ã‚¤ãƒ« / ${allPoints.length}ç‚¹`;

    dateSelect.disabled = false;

    rebuild();
  }

  function parseGPX(text) {
    const pts = [];
    const xml = new DOMParser().parseFromString(text, "application/xml");
    const trkpts = xml.getElementsByTagName("trkpt");
    for (let i = 0; i < trkpts.length; i++) {
      const lat = parseFloat(trkpts[i].getAttribute("lat"));
      const lng = parseFloat(trkpts[i].getAttribute("lon"));
      const timeEl = trkpts[i].getElementsByTagName("time")[0];
      if (timeEl) pts.push({ lat, lng, time: timeEl.textContent });
    }
    return pts;
  }

  slider.addEventListener('input', () => {
    stopPlayback();
    autoPanned = false;
    render(Number(slider.value));
  });

  dateSelect.addEventListener('change', () => {
    stopPlayback();
    selectedLogId = dateSelect.value;

    // ã€Œé–‹å§‹åœ°ç‚¹ã¸ã€ãƒœã‚¿ãƒ³å‰Šé™¤ã®ä»£ã‚ã‚Šã«ï¼šãƒ­ã‚°ã‚’é¸ã‚“ã ã‚‰è‡ªå‹•ã§é–‹å§‹åœ°ç‚¹ã¸
    if (selectedLogId) {
      jumpToSelectedLogStart();
    }

    rebuild();
  });

  map.on('zoomend', () => {
    if (!slider.disabled) render(Number(slider.value));
  });

  playBtn.addEventListener('click', () => {
    if (isPlaying) {
      stopPlayback();
      return;
    }
    startPlayback();
  });

  stopBtn.addEventListener('click', stopPlayback);

  loadFromGAS();
</script>

</body>
</html>
