<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Exploration Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
  </script>

  <style>
    html, body, #map { height: 100%; margin: 0; }
    .ctrl {
      position: absolute;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 6px;
    }
    #gpxInput { top: 10px; }
    #logInput { top: 50px; }
    #resetBtn { top: 90px; }
  </style>
</head>
<body>

<div id="map"></div>

<!-- GPX 読み込み（複数対応） -->
<input type="file" id="gpxInput" accept=".gpx" multiple class="ctrl" />

<!-- TXT 読み込み（複数対応） -->
<input type="file" id="logInput" accept=".txt" multiple class="ctrl" />

<!-- リセット（積み上げを消す） -->
<button id="resetBtn" class="ctrl">リセット</button>

<script>
  // =========================
  // 1. 地図の初期表示
  // =========================
  const centerLat = 35.719599;
  const centerLng = 140.160936;

  const map = L.map('map').setView([centerLat, centerLng], 14);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap'
  }).addTo(map);

  // 霧専用レイヤー（毎回ここだけ描き直す）
  const fogLayer = L.layerGroup().addTo(map);

  // =========================
  // 2. グリッド設定
  // =========================
  const GRID_SIZE = 0.001; // 約100m

  function gridKey(lat, lng) {
    const x = Math.floor(lat / GRID_SIZE);
    const y = Math.floor(lng / GRID_SIZE);
    return `${x}_${y}`;
  }

  function gridBounds(key) {
    const [x, y] = key.split('_').map(Number);
    const lat1 = x * GRID_SIZE;
    const lng1 = y * GRID_SIZE;
    const lat2 = lat1 + GRID_SIZE;
    const lng2 = lng1 + GRID_SIZE;
    return [[lat1, lng1], [lat2, lng2]];
  }

  // =========================
  // 3. 訪問済みグリッド（積み上げる）
  // =========================
  const visited = new Set();

  // =========================
  // 4. 霧を描画
  // =========================
  function drawFog() {
    fogLayer.clearLayers();

    const bounds = map.getBounds();
    const latMin = bounds.getSouth();
    const latMax = bounds.getNorth();
    const lngMin = bounds.getWest();
    const lngMax = bounds.getEast();

    const xStart = Math.floor(latMin / GRID_SIZE);
    const xEnd   = Math.floor(latMax / GRID_SIZE);
    const yStart = Math.floor(lngMin / GRID_SIZE);
    const yEnd   = Math.floor(lngMax / GRID_SIZE);

    for (let x = xStart; x <= xEnd; x++) {
      for (let y = yStart; y <= yEnd; y++) {
        const key = `${x}_${y}`;
        const b = gridBounds(key);
        const isVisited = visited.has(key);

        L.rectangle(b, {
          color: null,
          fillColor: isVisited ? '#ffffff' : '#000000',
          fillOpacity: isVisited ? 0.1 : 0.7,
          weight: 0
        }).addTo(fogLayer);
      }
    }
  }

  // ズーム/移動したら霧を描き直す（視界内だけ霧が更新される）
  map.on('moveend zoomend', drawFog);

  // =========================
  // 共通：ファイルをテキストで読む
  // =========================
  function readFileAsText(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(String(reader.result ?? ''));
      reader.onerror = reject;
      reader.readAsText(file);
    });
  }

  // =========================
  // 5. GPX（複数）読み込み → visitedに追加
  // =========================
  async function addFromGpxFiles(files) {
    const texts = await Promise.all(files.map(readFileAsText));

    for (const text of texts) {
      const parser = new DOMParser();
      const xml = parser.parseFromString(text, "application/xml");
      const points = xml.getElementsByTagName("trkpt");

      for (let i = 0; i < points.length; i++) {
        const lat = parseFloat(points[i].getAttribute("lat"));
        const lng = parseFloat(points[i].getAttribute("lon"));
        if (!Number.isFinite(lat) || !Number.isFinite(lng)) continue;
        visited.add(gridKey(lat, lng));
      }
    }
  }

  document.getElementById('gpxInput').addEventListener('change', async (e) => {
    const files = Array.from(e.target.files || []);
    if (files.length === 0) return;

    await addFromGpxFiles(files);
    drawFog();
  });

  // =========================
  // 6. walk_log_*.txt（複数）読み込み → visitedに追加
  // =========================
  function addFromWalkLogText(text) {
    const lines = text.split('\n');

    let lat = null;
    let lng = null;

    for (const raw of lines) {
      const line = raw.trim();

      // 例: 緯度: 35.xxxx
      if (line.startsWith('緯度:')) {
        lat = parseFloat(line.replace('緯度:', '').trim());
        if (!Number.isFinite(lat)) lat = null;
        continue;
      }

      // 例: 経度: 139.xxxx
      if (line.startsWith('経度:')) {
        lng = parseFloat(line.replace('経度:', '').trim());
        if (!Number.isFinite(lng)) lng = null;
        continue;
      }

      // 緯度・経度が揃ったら1点として追加
      if (lat !== null && lng !== null) {
        visited.add(gridKey(lat, lng));
        lat = null;
        lng = null;
      }
    }

    // 末尾が経度行で終わっていた場合にも対応
    if (lat !== null && lng !== null) {
      visited.add(gridKey(lat, lng));
    }
  }

  async function addFromTxtFiles(files) {
    const texts = await Promise.all(files.map(readFileAsText));
    for (const text of texts) addFromWalkLogText(text);
  }

  document.getElementById('logInput').addEventListener('change', async (e) => {
    const files = Array.from(e.target.files || []);
    if (files.length === 0) return;

    await addFromTxtFiles(files);
    drawFog();
  });

  // =========================
  // 7. リセット
  // =========================
  document.getElementById('resetBtn').addEventListener('click', () => {
    visited.clear();
    drawFog();
  });

  // 起動時：全面霧
  drawFog();
</script>

</body>
</html>
